(function () {
    const global = window.tinymce.util.Tools.resolve('tinymce.PluginManager');

    const register = editor => {
        const letter_spacing_formats = editor.getParam('letter_spacing_formats', '1pt 1.5pt 2pt 2.5pt 3pt 3.5pt 4pt 4.5pt 5pt 1em 1.5em 2em 2.5em 3em 3.5em 4em 4.5em 5em');
        editor.ui.registry.addIcon('letterSpacing', '<svg viewBox="0 0 1062 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M347.461771 224.90285c58.254589 0 95.025217 29.776535 121.496528 62.887807 14.224272 17.765584 22.575867 42.613793 27.710769 68.229286 1.062394 8.528661 2.124787 26.648376 2.124788 144.957722v136.429061c-9.059858 15.080089-23.31364 36.475518-51.171965 30.897951-19.300153-4.810283-30.219199-14.932534-36.23943-33.052249-1.062394-4.249575-1.062394-20.244503-1.062394-74.603648V491.3571H277.078187v69.29168c0 56.483933 0 71.416467-1.062394 75.666042a55.893715 55.893715 0 0 1-13.87014 21.306896c-2.124787 2.124787-6.403873 6.403873-9.591055 7.466267-31.665235 10.564915-53.886971-5.193925-62.887806-27.71077v-139.616242c0-132.179486-1.062394-139.616243 1.062393-148.144903 7.761376-38.777371 31.606213-72.44935 58.608721-92.723364 24.612121-18.473847 54.18208-31.989856 98.064843-31.989856z m197.192081 43.705698c0-26.205712 18.208248-43.705698 43.705697-43.705698 16.437592 0 25.940114 8.882792 34.114643 17.057322 2.124787 2.124787 5.34148 6.403873 6.403874 9.591054 4.10202 12.335572 69.026081 182.348079 92.723363 244.084959 13.279922-33.878556 91.365861-243.612784 93.785758-247.27214 7.289201-10.948558 18.326292-23.461195 36.23943-23.461195 18.326292 0 28.123923 7.87942 37.301825 17.057322 6.167786 6.167786 9.591054 12.630681 9.591054 25.585982v10.653448l-68.199775 182.259547c-37.301824 100.189631-69.29168 184.384334-71.416467 187.601026-4.042998 6.079253-11.096112 14.696447-18.119716 17.057321-24.671143 8.233551-49.607885-1.150927-58.60872-19.182109-1.062394-2.124787-33.052249-86.31949-70.354074-185.446727l-68.199775-181.197153z m-196.129687 45.830485h-11.715842c-10.476383 0-15.021067 3.246203-23.461195 7.466267-23.372662 9.354967-36.239431 34.586818-36.23943 67.137381v13.870141h133.24188v-17.057322c0-28.596098-7.082625-39.07248-21.306897-53.296752-9.177901-9.177901-24.464567-18.119715-40.489005-18.119715z m-26.648376 443.372316c-9.089369 0-14.962045 1.091905-21.306897 5.34148-5.459523 2.715006-105.885242 101.635667-108.718291 108.718291-3.836422 11.538776-6.167786 27.533704 1.062394 38.364218 8.233551 13.722586 94.464509 101.606156 110.843079 109.780686 4.249575 2.124787 9.591054 4.249575 14.932534 4.249574 18.326292 0 28.123923-7.87942 37.301824-17.057321 6.905559-6.905559 8.528661-11.65682 8.528661-26.648376 0-19.241131-3.983976-24.25799-14.932534-35.177037l-8.528661-9.591054h405.037609l-8.528661 9.591054c-10.919047 10.919047-14.932534 15.965417-14.932534 35.177037 0 28.684631 17.32292 43.705698 45.830485 43.705697 5.34148 0 10.653448-2.124787 14.932534-4.249574 16.37857-8.20404 102.609528-96.0581 110.843079-109.780686 6.433384-9.650076 6.758005-28.241967 0-38.364218-8.233551-13.722586-94.464509-101.606156-110.843079-109.780685a34.734373 34.734373 0 0 0-14.932534-4.249575c-27.858324 0-45.830485 15.463731-45.830485 43.705698 0 19.241131 3.983976 24.25799 14.932534 35.177036l8.528661 9.591055H341.057898l8.528661-9.591055c10.919047-10.919047 14.932534-15.965417 14.932534-35.177036 0-15.080089-1.56408-19.683795-8.528661-26.648376-8.145019-8.145019-17.559007-17.057322-34.114643-17.057322z"></path></svg>')
        editor.ui.registry.addMenuButton('letterSpacing', {
            icon: 'letterSpacing',
            tooltip: '字体间距',
            fetch: (callback) => {
                let dom = editor.dom
                let blocks = editor.selection.getSelectedBlocks()
                let lhv = 0
                for (let i = 0; i < blocks.length; i++) {
                    let block = blocks[i]
                    if (lhv === 0) {
                        lhv = dom.getStyle(block, 'letter-spacing') ? dom.getStyle(block, 'letter-spacing') : 0;
                    }
                }
                const items = letter_spacing_formats.split(' ').map((item) => {
                    return {
                        type: 'togglemenuitem',
                        text: item,
                        value: item,
                        active: lhv === item,
                        onAction: () => {
                            editor.formatter.apply('letterSpacingFormatter', {value: item})
                            editor.fire('change', {})
                        }
                    }
                })
                callback(items)
            }
        })
    }
    const Plugin = () => {
        global.add('letterSpacing', (editor) => {
            register(editor)
            editor.on('init', () => {
                editor.formatter.register('letterSpacingFormatter', {
                    selector: 'p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table',
                    styles: {'letter-spacing': '%value'}
                })
            })
        })
    };
    Plugin()
})();
